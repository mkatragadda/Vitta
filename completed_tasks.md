# Completed Tasks

- [2025-11-07] Enhancement: Multi-factor tie-breakers for recommendation strategies. Implemented deterministic fallback hierarchy when scores tie: (1) Rewards Optimizer now falls back to eligibility ‚Üí available credit ‚Üí lower utilization ‚Üí longer grace period ‚Üí lower APR ‚Üí alphabetical. (2) APR Optimizer now falls back to lower APR ‚Üí available credit ‚Üí lower utilization ‚Üí longer grace period ‚Üí higher rewards multiplier ‚Üí alphabetical. (3) Grace Period Optimizer now falls back to eligibility ‚Üí later payment due date ‚Üí available credit ‚Üí lower utilization ‚Üí higher rewards multiplier ‚Üí lower APR ‚Üí alphabetical. Added helper utilities (`getGracePeriodDays`, `getCardAPR`, `getDefaultRewardMultiplier`) and reused existing formatters to keep console summary clean. Ensures consistent, explainable ordering when two cards share the same primary score.

- [2025-11-07] Enhancement: Comprehensive scoring weightage and parameter logging for all recommendation strategies. **Purpose:** Enable verification and debugging of card scoring calculations by exposing all parameters, formulas, and weights used in each strategy. **Implementation:** Added detailed console logging to all three scoring functions (Rewards, APR, Grace Period) showing: (1) **Scoring Parameters** - all input values (multiplier, APR, statement dates, amounts), (2) **Formulas** - exact calculation steps with actual values, (3) **Weights** - contribution of each parameter to final score (currently 100% single-factor, designed for future multi-factor weighted scoring), (4) **Score Breakdown** - step-by-step calculation trace. **Added Summary Sections:** (1) **Methodology Overview** at start - explains scoring formula, weightage, filters, and ranking for all 3 strategies, (2) **Score Comparison Matrix** at end - side-by-side scores for all cards across all strategies with eligibility markers (‚úÖ/‚ùå), (3) **Winners Summary** - best card per strategy. **Example Output:** "Bofa Cash Rewards: Rewards Score: 15.00 ‚úÖ (Cashback: $15.00), APR Score: -17.08 ‚úÖ (Interest: $17.08/mo), Grace Period Score: 28 ‚úÖ (Float: 28 days)". **User Profile Logging:** Enhanced to show behavioral metrics (cards with balance, total debt, avg utilization, high-util cards), classification logic with confidence scores, and reasoning for profile detection. **Result:** Complete transparency into scoring algorithm - can now verify multiplier lookups, interest calculations, float time logic, and understand why each card ranks where it does. Files: `recommendationStrategies.js`, `userProfileDetector.js`.

- [2025-11-07] Fix: Missing dollar calculations in multi-strategy recommendations + Classification fix + Simplification. **Issue 1:** Dollar calculations (cashback earnings, interest costs) missing when no amount specified in query like "compare all strategies". **Root Cause:** Code defaulted to `amount = 0` when entities.amount was null, then formatter skipped dollar calculations with `if (amount > 0)` check. **Solution:** Added default amount of $1000 in `conversationEngineV2.js:65` and `recommendationChatHandler.js:67` when user doesn't specify amount. Added helpful note "üí° Showing example with $1,000 purchase. Specify an amount for custom calculations." in formatter header when using default. **Issue 2:** "compare all strategies" firing wrong intent (money_coaching instead of card_recommendation). **Root Cause:** Stage 1 classifier prompt said "GUIDANCE - User wants financial advice or strategy", so "compare all **strategies**" triggered GUIDANCE. **Solution:** Updated classifier prompt to explicitly include "Compare cards or compare strategies **for a purchase**" under TASK category, clarified GUIDANCE as "(NOT purchase-related)". **Issue 3:** Showing all 5 cards per strategy instead of just winner. **User Feedback:** Too verbose, just show top card. **Solution:** Simplified all three formatters (Rewards, APR, Grace Period) in `recommendationFormatterPlainText.js` to show ONLY the winner card with key metrics, removed loops showing all cards. Added count of ineligible cards as footnote (e.g., "‚ö†Ô∏è 3 other cards have balances - no grace period"). **Result:** Clean output with 3 options, each showing ONLY best card + dollar calculations (e.g., "Earn $40.00 on this purchase" for rewards, "Carrying $1,000 costs $17.08/month" for APR, "38 days to pay" for grace period). Files: `conversationEngineV2.js`, `recommendationChatHandler.js`, `recommendationFormatterPlainText.js`.

- [2025-11-07] AI/Architecture: Complete redesign of card recommendation engine V2 + Integration fix + Import bug fix + Dynamic option numbering fix + Plain text format solution. **Issues:** (1) Citi Costco with $20,999 balance recommended for cashflow - violates grace period rule, (2) Single confusing table mixing 3 strategies, (3) No user profile consideration, (4) No actual $$ impact shown, (5) Cards with balances recommended for rewards/cashflow. **Import Bug:** After integration fix, users still saw confusing GPT-generated numbered list format with error "TypeError: calculateFloatTime is not a function". Root cause: Wrong import in `recommendationStrategies.js` line 6 - imported `calculateFloatTime` from `paymentCycleUtils.js` but it's actually in `statementCycleUtils.js`. Error caused fallback to GPT which generated old-style response. Fixed by splitting imports: `calculateFloatTime` from `statementCycleUtils.js`, `getPaymentDueDateForFloat` from `paymentCycleUtils.js`. **Option Numbering Bug:** After import fix, APR_MINIMIZER profile correctly detected but showed "Option 2: Minimize Interest ‚≠ê BEST FOR YOU" when it should be "Option 1" (first table). Root cause: Option numbers were hardcoded in formatter functions instead of being dynamic based on table order. Fixed by passing `optionNumber = index + 1` parameter to each format function and using template literals `Option ${optionNumber}` instead of hardcoded "Option 1/2/3". Now APR_MINIMIZER shows APR as Option 1, REWARDS_MAXIMIZER shows Rewards as Option 1. **Chat UI Limitation Discovered:** After all fixes, user still saw single merged table. Deep investigation revealed ROOT CAUSE: Chat UI component (`VittaApp.js` lines 108-141) only supports ONE table per message! The `MessageContent` component collects ALL lines starting/ending with `|` into a single `tableLines` array and renders them as ONE `<table>` element. Multiple markdown tables will ALWAYS merge. **Solution:** Created new `recommendationFormatterPlainText.js` using plain text formatting instead of markdown tables. Format uses numbered lists with bullet points, emoji icons, visual separators (‚îÅ‚îÅ‚îÅ), and clear "Winner" sections. Benefits: (1) Three clearly separated sections, (2) Works perfectly with chat UI, (3) More readable on mobile, (4) No table parsing issues, (5) Better visual hierarchy. Updated `conversationEngineV2.js` line 62 and `recommendationChatHandler.js` line 64 to import plain text formatter. Kept markdown formatter for potential future use if chat UI adds multi-table support. **New Architecture:** Three-layer design: (1) User Profile Detector - ML-based behavior analysis detecting REWARDS_MAXIMIZER (pays in full) vs APR_MINIMIZER (carries balances) vs BALANCED, (2) Three Separate Scoring Functions - `scoreForRewards()` (ONLY $0 balance cards, shows actual cashback $$$), `scoreForAPR()` (shows monthly/annual interest cost), `scoreForGracePeriod()` (ONLY $0 balance cards, calculates float days), (3) Three Separate Tables with clear presentation and $$ impact. **Integration Bug Found:** After implementation, users still saw old single-table format because `conversationEngineV2.js` was bypassing new architecture and calling old `getAllStrategyRecommendations()` function. **Fix:** Updated `conversationEngineV2.js` lines 59-76 to use new `getAllStrategies()` and `formatMultiStrategyRecommendations()`. **Key Improvements:** Grace period rule ENFORCED (cards with balance get -1000 penalty score, NOT recommended for rewards/cashflow), actual dollar amounts shown ("Earn $15 cashback" not just "1.5x"), user profile-aware (reorders tables, marks "‚≠ê BEST FOR YOU"), three clean separate tables (not one confusing table), educational explanations. **Example:** For $1,000 grocery purchase, Rewards table shows "Earn $15.00 cashback, $180/year if monthly", APR table shows "If you carry balance: $15.83/month interest", Grace Period table shows "38 days to pay, due 11/14/2025" with ‚ö†Ô∏è warnings for cards with balances. **Files:** Created `userProfileDetector.js`, `recommendationStrategies.js`, `recommendationFormatter.js`; Updated `recommendationChatHandler.js`, `conversationEngineV2.js`. **Result:** Citi Costco with $20,999 balance now shows "‚ö†Ô∏è No grace period - Interest charges immediately" in separate Grace Period table and is NOT recommended. Architecture is generic, ML-based, and works for all users automatically. All code paths now use new architecture.

- [2025-11-06] Fix: Payment due date calculation bug (ALL cards showing incorrect dates). **Issue:** All payment due dates were wrong by 1-15 days across all cards. bofa unlimited: showed 11/15 instead of 11/16, citi master: showed 11/17 instead of 11/8 (9 days off!), citi costco: showed 12/1 instead of 11/28, bofa travel: showed 11/24 instead of 11/9 (15 days off!). **Root Cause:** Bug in `statementCycleUtils.js:108` - `getPaymentDueDate()` was RECALCULATING the statement close date even when already calculated, causing month shift errors. Function received already-calculated statement Date (e.g., Oct 25, 2025) as parameter, then recalculated it using `getStatementCloseDate(25, Oct 25)`, which could return different month. **Solution:** Generic fix (not card-specific): (1) Changed `getPaymentDueDate` to use provided statement close Date directly instead of recalculating, (2) Fixed callers `getDaysUntilPaymentDue` and `calculateFloatTime` to pass correct statement close Date, (3) Made third parameter optional for backward compatibility. **Result:** All payment due dates now calculate correctly for ALL cards automatically. Generic solution works across entire codebase. Files: `utils/statementCycleUtils.js` (3 functions fixed).

- [2025-11-06] Database: Removed redundant `network` column from `user_credit_cards` table. **Issue:** Table had both `network` and `card_network` columns serving the same purpose, causing confusion. **Root Cause:** Old schema file (CARD_RECOMMENDATION_SCHEMA.sql) used `network`, while official schema.sql uses `card_network`. **Solution:** (1) Created migration `supabase/migrations/20251106_remove_network_column.sql` to migrate data from `network` ‚Üí `card_network` and drop redundant column from user_credit_cards ONLY. (2) Updated CARD_RECOMMENDATION_SCHEMA.sql to use `card_network` instead of `network`. (3) Fixed bug in `scripts/loadCardsToDatabase.js` line 115 (was using `network:` property, changed to `card_network:`). **Note:** `card_catalog` table keeps `network` column as intended. **Result:** Database cleaned up - user_credit_cards now uses only `card_network`, matching all application code. No code changes needed as everything already used `card_network`. Files: migration script, CARD_RECOMMENDATION_SCHEMA.sql, loadCardsToDatabase.js.

- [2025-11-06] Chat: Fixed nickname display in chat responses. **Issue:** Cards showing official names (e.g., "Unlimited Cash Rewards") instead of user-assigned nicknames (e.g., "My Travel Card"). **Solution:** Updated all chat response handlers to prioritize `nickname || card_name` pattern consistently. Files modified: `cardDataQueryHandler.js` (21 instances), `responseGenerator.js` (9 instances), `conversationEngineV2.js` (1 instance), `conversationEngine.js` (1 instance). Already correct: `recommendationChatHandler.js`, `debtGuidanceHandler.js`, `moneyCoachingHandler.js`, `cardComparisonHandler.js`. **Result:** All chat responses now display user's personalized card nicknames when available, falling back to official card name if no nickname set.

- [2025-11-06] Fix: intent_logs.user_id was null and caused FK errors during recommendation intent logging. Implemented migration `supabase/migrations/20251106_fix_intent_logs_user_fk.sql` to change FK from `auth.users(id)` to `public.users(id)` with `ON DELETE SET NULL`. Verified that new intent logs persist with a populated `user_id`.

- [2025-11-06] UI: Fixed VittaChatInterface text box overflow. Replaced single-line input with a multiline, wrapping textarea in `components/VittaChatInterface.js`, added auto-resize with a max height to prevent left-shift on long input, and aligned the Send button with the input bottom.

- [2025-11-06] AI: Implemented hierarchical two-stage intent classification (Option A - Zero-shot LLM). Added category classifier (TASK/GUIDANCE/CHAT) as Stage 1, then vector similarity search within category as Stage 2. Created 3 new intents (`debt_guidance`, `money_coaching`, `chit_chat`) with 100+ examples. Added handlers for debt payoff strategies, financial coaching, and casual conversation. Updated `conversationEngineV2.js` with category-aware GPT prompting. Backward compatible - existing intents unchanged. Next step: Generate embeddings via admin page at `/admin/embeddings`.

- [2025-11-06] AI: Implemented context-aware follow-up handling (MVP - Option A Session-Based). Created `ConversationContext` class to track last 5 turns, active entities, and pending actions. Implemented `QueryRewriter` with 12 follow-up patterns covering ALL intents: **card_recommendation** (compare strategies, show alternatives, why not X), **debt_guidance** (show plan, how much to pay, snowball method), **money_coaching** (explain more, specific topics), **split_payment** (avalanche, what-if scenarios, recalculate), **query_card_data** (show details, specific cards), plus generic patterns. Added direct routing for high-confidence follow-ups (‚â•0.85) to bypass classification. Integrated into `conversationEngineV2.js` - automatically updates context after each turn. **Fixes:** "compare all strategies" after "which card for groceries" now correctly routes to multi-strategy comparison with context entities. Backward compatible - works seamlessly with existing flow. Files: `conversationContext.js`, `queryRewriter.js`, updated `conversationEngineV2.js` and `recommendationChatHandler.js`.

- [2025-11-06] Fix: Multi-strategy comparison errors and formatting issues (FINAL FIX v2). **Issue 1:** `Invalid amount` error when amount is null - fixed by relaxing validation in `recommendationEngine.js`. **Issue 2:** Comparison table header printed separately - ROOT CAUSE: GPT was generating response instead of direct route. **Issue 3:** Wrong intent classification - "compare all strategies" was classified as GUIDANCE‚Üímoney_coaching instead of direct routing to card_recommendation. **Issue 4:** Unclear "Value" column - users didn't understand what it meant. **Issue 5:** Duplicate cards and wrong calculations. **Issue 6:** Cards with balances shown for cashflow optimization (violates grace period rule). **Issue 7:** Duplicate cards not explained (user confused why same card appears multiple times). **ROOT CAUSE:** Query rewriter confidence was 0.95 but threshold is 0.85, yet it still went through normal classification which overrode it. **FINAL SOLUTION:** (1) Increased confidence to 0.98 for "compare all strategies" pattern to ensure direct routing, (2) Renamed "Value" column to "Cashback" for clarity, (3) Added explanatory text "*Each row shows the best card for that optimization strategy*", (4) Moved category mapping before response building to ensure correct reward lookups, (5) Added debug logging to trace pattern matching, (6) Added ‚ö†Ô∏è warning icon for cards with balance in cashflow row, (7) Added "Notes" section explaining warnings and duplicate cards (e.g., "Customized Cash Rewards wins for 2 strategies: Rewards + Low APR"). Table format: Strategy | Card | Rewards | Cashback | Utilization | APR. Header and table now in single message via direct route. Files: `queryRewriter.js` (increased confidence), `recommendationChatHandler.js` (renamed column, added warnings, added notes).

- [2025-11-06] AI/ML: Implemented Slot-Filling Dialog Manager for multi-turn question-answer flows (FIXED v2). **Problem:** User says "5000" after debt guidance asks for budget, but system fires card_recommendation instead of split_payment. **Root Cause 1:** System treats each query independently, doesn't track that bot asked a question. **Root Cause 2:** Entity extractor also finds "5000" and treats it as purchase amount, creating race condition. **Solution:** Implemented state machine with 3 layers + priority enforcement: (1) **Pending Question Tracker** - tracks what question was asked, what slots need filling, timeout management, (2) **Answer Detection & Slot Extraction** - pattern matching for answers (budget amounts, confirmations, card selections), confidence scoring (0.80+ threshold), improved to 0.98 for just numbers, (3) **Intent Transition Logic** - if answering question ‚Üí fill slot and execute target intent, if all slots filled ‚Üí execute intent with slots, if no clear answer ‚Üí clear state and continue normal processing. **Critical Fix:** Slot-filling check happens FIRST (STEP 0A) before any other processing, with comprehensive logging to debug state. Added early return when answer detected to prevent fallthrough to normal classification. **Implementation:** Created `SlotFillingManager` class with 5 question types. Integrated into `conversationEngineV2.js` as STEP 0A with priority enforcement. Updated `debtGuidanceHandler.js` to set up slot-filling. **Result:** "5000" now correctly fills budget slot (confidence 0.98) and executes split_payment intent with amount=$5000. Files: `slotFillingManager.js` (new, improved patterns), `conversationEngineV2.js` (integrated with priority), `debtGuidanceHandler.js` (sets up question).

- [2025-11-06] Fix: Payment due date calculation (comprehensive fix across 5 critical issues). **Issue 1:** "My Travel" card showing due date 11/6/2025 instead of 11/9/2025. **Root Cause:** Grace period in database was 25 days but should be 28 days. **Solution:** Created migration `supabase/migrations/20251106_fix_my_travel_grace_period.sql` to update grace_period_days from 25‚Üí28. Calculation verified: Oct 12 (statement close) + 28 days = Nov 9 (correct). **Issue 2:** Emoji showing green (üü¢ OK) for 3 days remaining instead of yellow (üü° Soon). **Root Cause:** `currentPayment` object had hardcoded `isUrgent: false`. **Solution:** Changed to dynamic calculation in `paymentCycleUtils.js:137-139`: `isUrgent: daysUntilCurrent >= 0 && daysUntilCurrent <= 7`. **Issue 3:** Showing old overdue payment (Oct 9) instead of current payment (Nov 9). **Root Cause:** Logic showed previous payment if within 30 days overdue. **Solution:** Changed threshold to 7 days in `paymentCycleUtils.js:156`: `if (previousPayment && previousPayment.daysUntilDue >= -7)`. **Issue 4:** Amount showing $0 for some cards. **Root Cause:** Card-specific fix only worked for "My Travel", not generic. **Solution:** Implemented centralized `getPaymentAmount()` helper function at `paymentCycleUtils.js:113-117` with priority logic: `amount_to_pay || current_balance || 0`. Applied to ALL payment types (previous, current, fallback). **Issue 5:** Stale card data in chat after DB updates. **Root Cause:** Cards cached at login. **Solution:** Added `await refreshCards()` in `VittaApp.js:924-931` before processing each query. **Issue 6:** Table showing single "Amount" column instead of separate "Current Balance" and "Min Payment Due" columns. **Solution:** Updated `cardDataQueryHandler.js:208-228` to split into two columns with proper headers. **Result:** All cards now show (1) correct payment due dates, (2) appropriate urgency emojis (red/yellow/green), (3) accurate amounts from database, (4) fresh data after updates, (5) separate balance and payment columns with attached headers. Files modified: `paymentCycleUtils.js`, `VittaApp.js`, `cardDataQueryHandler.js`, `20251106_fix_my_travel_grace_period.sql`. Debug logging removed after verification.

- [2025-11-06] Fix: Cashflow strategy recommending wrong card (card with balance instead of card without balance). **Problem:** "Bofa unlimited cash rewards" (81% utilization, HAS balance) recommended for cashflow instead of "Bofa Cash Rewards" (0% utilization, NO balance). **Root Cause:** Cards with balances were getting -200 penalty but still had positive scores from float calculation, allowing them to win over cards without balances. **Grace Period Rule:** Cards with balances lose grace period ‚Üí interest charges immediately ‚Üí NOT eligible for cashflow optimization. **Solution:** Changed penalty from -200 (which could still result in positive score) to hard return 0 in `recommendationEngine.js:261`. Cards without grace period now get score=0 immediately, making them ineligible. Added comprehensive debug logging to track: card name, balance, grace period check, and final scores. **Result:** Cards with balances now correctly get score=0 for cashflow strategy, ensuring only cards with $0 balance (grace period available) are recommended for cashflow optimization. Files: `recommendationEngine.js` (fixed scoring), `cardComparisonHandler.js` (new, for future "why not X" queries).
